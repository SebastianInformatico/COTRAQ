import React, { useState, useEffect } from 'react';
import {
  Box,
  Grid,
  Card,
  CardMedia,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Dialog,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  Menu,
  MenuItem,
  Fab,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  List,
  ListItem,
  ListItemText,
  ListItemIcon,
  Badge,
  Tooltip,
  FormControl,
  InputLabel,
  Select,
  Tabs,
  Tab,
} from '@mui/material';
import {\n  PhotoCamera as CameraIcon,\n  Visibility as ViewIcon,\n  Edit as EditIcon,\n  Delete as DeleteIcon,\n  Download as DownloadIcon,\n  MoreVert as MoreVertIcon,\n  LocationOn as LocationIcon,\n  Schedule as TimeIcon,\n  Person as PersonIcon,\n  CheckCircle as VerifiedIcon,\n  Warning as UnverifiedIcon,\n  Add as AddIcon,\n  Search as SearchIcon,\n  FilterList as FilterIcon,\n  Map as MapIcon,\n  Info as InfoIcon,\n  Share as ShareIcon,\n} from '@mui/icons-material';\nimport { format } from 'date-fns';\nimport { es } from 'date-fns/locale';\nimport { Photo } from '@/types';\nimport PhotoUpload from './PhotoUpload';\nimport apiService from '@/services/api';\nimport { useAuthStore } from '@/store/authStore';\n\ninterface TabPanelProps {\n  children?: React.ReactNode;\n  index: number;\n  value: number;\n}\n\nconst TabPanel: React.FC<TabPanelProps> = ({ children, value, index }) => (\n  <div hidden={value !== index}>\n    {value === index && <Box sx={{ py: 2 }}>{children}</Box>}\n  </div>\n);\n\ninterface PhotoGalleryProps {\n  tripId?: string;\n  vehicleId?: string;\n  maintenanceId?: string;\n  showUploadButton?: boolean;\n  filterType?: string;\n  title?: string;\n}\n\nconst PhotoGallery: React.FC<PhotoGalleryProps> = ({\n  tripId,\n  vehicleId,\n  maintenanceId,\n  showUploadButton = true,\n  filterType,\n  title = 'Galer칤a de Fotos',\n}) => {\n  const { user } = useAuthStore();\n  const [photos, setPhotos] = useState<Photo[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [selectedPhoto, setSelectedPhoto] = useState<Photo | null>(null);\n  const [openUpload, setOpenUpload] = useState(false);\n  const [openViewer, setOpenViewer] = useState(false);\n  const [menuAnchor, setMenuAnchor] = useState<HTMLElement | null>(null);\n  const [activeTab, setActiveTab] = useState(0);\n  \n  // Estados de filtro y b칰squeda\n  const [searchTerm, setSearchTerm] = useState('');\n  const [typeFilter, setTypeFilter] = useState<string>(filterType || 'all');\n  const [categoryFilter, setCategoryFilter] = useState('all');\n  const [verificationFilter, setVerificationFilter] = useState('all');\n  const [showFilters, setShowFilters] = useState(false);\n\n  // Estad칤sticas\n  const [stats, setStats] = useState({\n    total: 0,\n    verified: 0,\n    unverified: 0,\n    byType: {} as Record<string, number>,\n  });\n\n  useEffect(() => {\n    loadPhotos();\n  }, [tripId, vehicleId, maintenanceId]);\n\n  useEffect(() => {\n    calculateStats();\n  }, [photos]);\n\n  const loadPhotos = async () => {\n    setLoading(true);\n    setError(null);\n    \n    try {\n      const params: any = {};\n      if (tripId) params.trip_id = tripId;\n      if (vehicleId) params.vehicle_id = vehicleId;\n      if (maintenanceId) params.maintenance_id = maintenanceId;\n      if (filterType && filterType !== 'all') params.type = filterType;\n\n      const response = await apiService.getPhotos(params);\n      setPhotos(response.data.photos);\n    } catch (error: any) {\n      setError(error.response?.data?.message || 'Error al cargar fotos');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const calculateStats = () => {\n    const total = photos.length;\n    const verified = photos.filter(p => p.is_verified).length;\n    const unverified = total - verified;\n    \n    const byType = photos.reduce((acc, photo) => {\n      acc[photo.type] = (acc[photo.type] || 0) + 1;\n      return acc;\n    }, {} as Record<string, number>);\n\n    setStats({ total, verified, unverified, byType });\n  };\n\n  const getFilteredPhotos = () => {\n    return photos.filter(photo => {\n      // Filtro de b칰squeda\n      if (searchTerm) {\n        const searchLower = searchTerm.toLowerCase();\n        const matchesSearch = \n          photo.title?.toLowerCase().includes(searchLower) ||\n          photo.notes?.toLowerCase().includes(searchLower);\n        if (!matchesSearch) return false;\n      }\n\n      // Filtro por tipo\n      if (typeFilter !== 'all' && photo.type !== typeFilter) return false;\n\n      // Filtro por categor칤a (si estuviera disponible en el tipo Photo)\n      // if (categoryFilter !== 'all' && photo.category !== categoryFilter) return false;\n\n      // Filtro por verificaci칩n\n      if (verificationFilter === 'verified' && !photo.is_verified) return false;\n      if (verificationFilter === 'unverified' && photo.is_verified) return false;\n\n      return true;\n    });\n  };\n\n  const handlePhotoClick = (photo: Photo) => {\n    setSelectedPhoto(photo);\n    setOpenViewer(true);\n  };\n\n  const handleMenuClick = (event: React.MouseEvent<HTMLElement>, photo: Photo) => {\n    event.stopPropagation();\n    setSelectedPhoto(photo);\n    setMenuAnchor(event.currentTarget);\n  };\n\n  const handleMenuClose = () => {\n    setMenuAnchor(null);\n    setSelectedPhoto(null);\n  };\n\n  const handleDownloadPhoto = () => {\n    if (selectedPhoto) {\n      // Simular descarga\n      const link = document.createElement('a');\n      link.href = selectedPhoto.file_url;\n      link.download = selectedPhoto.file_name;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n    }\n    handleMenuClose();\n  };\n\n  const handleDeletePhoto = async () => {\n    if (selectedPhoto && window.confirm('쮼st치 seguro de eliminar esta foto?')) {\n      try {\n        // await apiService.deletePhoto(selectedPhoto.id);\n        setPhotos(photos.filter(p => p.id !== selectedPhoto.id));\n        alert('Foto eliminada');\n      } catch (error) {\n        alert('Error al eliminar foto');\n      }\n    }\n    handleMenuClose();\n  };\n\n  const getPhotoTypeLabel = (type: string) => {\n    const types: Record<string, string> = {\n      pre_trip: 'Pre-Viaje',\n      during_trip: 'Durante Viaje',\n      post_trip: 'Post-Viaje',\n      maintenance: 'Mantenimiento',\n      damage: 'Da침o',\n      cargo: 'Carga',\n      signature: 'Firma',\n      document: 'Documento',\n      incident: 'Incidente',\n      general: 'General',\n    };\n    return types[type] || type;\n  };\n\n  const getPhotoTypeColor = (type: string) => {\n    const colors: Record<string, 'primary' | 'secondary' | 'success' | 'warning' | 'error' | 'info'> = {\n      pre_trip: 'primary',\n      during_trip: 'warning',\n      post_trip: 'success',\n      maintenance: 'info',\n      damage: 'error',\n      cargo: 'secondary',\n      signature: 'info',\n      document: 'secondary',\n      incident: 'error',\n      general: 'primary',\n    };\n    return colors[type] || 'primary';\n  };\n\n  const handleTabChange = (event: React.SyntheticEvent, newValue: number) => {\n    setActiveTab(newValue);\n  };\n\n  const filteredPhotos = getFilteredPhotos();\n  const photosByType = filteredPhotos.reduce((acc, photo) => {\n    if (!acc[photo.type]) acc[photo.type] = [];\n    acc[photo.type].push(photo);\n    return acc;\n  }, {} as Record<string, Photo[]>);\n\n  if (loading) {\n    return (\n      <Box sx={{ display: 'flex', justifyContent: 'center', p: 4 }}>\n        <CircularProgress />\n      </Box>\n    );\n  }\n\n  return (\n    <Box>\n      {/* Header */}\n      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>\n        <Typography variant=\"h5\" component=\"h2\" sx={{ fontWeight: 'bold' }}>\n          游닞 {title}\n        </Typography>\n        \n        <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>\n          <IconButton onClick={() => setShowFilters(!showFilters)}>\n            <FilterIcon />\n          </IconButton>\n          {showUploadButton && (\n            <Button\n              variant=\"contained\"\n              startIcon={<CameraIcon />}\n              onClick={() => setOpenUpload(true)}\n            >\n              Nueva Foto\n            </Button>\n          )}\n        </Box>\n      </Box>\n\n      {error && (\n        <Alert severity=\"error\" sx={{ mb: 3 }}>\n          {error}\n        </Alert>\n      )}\n\n      {/* Estad칤sticas r치pidas */}\n      <Grid container spacing={2} sx={{ mb: 3 }}>\n        <Grid item xs={6} sm={3}>\n          <Paper sx={{ p: 2, textAlign: 'center' }}>\n            <Typography variant=\"h4\" color=\"primary\">{stats.total}</Typography>\n            <Typography variant=\"caption\">Total Fotos</Typography>\n          </Paper>\n        </Grid>\n        <Grid item xs={6} sm={3}>\n          <Paper sx={{ p: 2, textAlign: 'center' }}>\n            <Typography variant=\"h4\" color=\"success.main\">{stats.verified}</Typography>\n            <Typography variant=\"caption\">Verificadas</Typography>\n          </Paper>\n        </Grid>\n        <Grid item xs={6} sm={3}>\n          <Paper sx={{ p: 2, textAlign: 'center' }}>\n            <Typography variant=\"h4\" color=\"warning.main\">{stats.unverified}</Typography>\n            <Typography variant=\"caption\">Sin Verificar</Typography>\n          </Paper>\n        </Grid>\n        <Grid item xs={6} sm={3}>\n          <Paper sx={{ p: 2, textAlign: 'center' }}>\n            <Typography variant=\"h4\" color=\"info.main\">\n              {stats.total > 0 ? Math.round((stats.verified / stats.total) * 100) : 0}%\n            </Typography>\n            <Typography variant=\"caption\">Verificaci칩n</Typography>\n          </Paper>\n        </Grid>\n      </Grid>\n\n      {/* Filtros */}\n      {showFilters && (\n        <Paper sx={{ p: 2, mb: 3 }}>\n          <Typography variant=\"subtitle1\" gutterBottom>Filtros</Typography>\n          <Grid container spacing={2}>\n            <Grid item xs={12} sm={6} md={3}>\n              <TextField\n                fullWidth\n                size=\"small\"\n                label=\"Buscar\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                InputProps={{\n                  startAdornment: <SearchIcon sx={{ mr: 1, color: 'text.disabled' }} />\n                }}\n              />\n            </Grid>\n            <Grid item xs={12} sm={6} md={3}>\n              <FormControl fullWidth size=\"small\">\n                <InputLabel>Tipo</InputLabel>\n                <Select\n                  value={typeFilter}\n                  onChange={(e) => setTypeFilter(e.target.value)}\n                >\n                  <MenuItem value=\"all\">Todos</MenuItem>\n                  <MenuItem value=\"pre_trip\">Pre-Viaje</MenuItem>\n                  <MenuItem value=\"during_trip\">Durante Viaje</MenuItem>\n                  <MenuItem value=\"post_trip\">Post-Viaje</MenuItem>\n                  <MenuItem value=\"maintenance\">Mantenimiento</MenuItem>\n                  <MenuItem value=\"damage\">Da침o</MenuItem>\n                  <MenuItem value=\"cargo\">Carga</MenuItem>\n                </Select>\n              </FormControl>\n            </Grid>\n            <Grid item xs={12} sm={6} md={3}>\n              <FormControl fullWidth size=\"small\">\n                <InputLabel>Verificaci칩n</InputLabel>\n                <Select\n                  value={verificationFilter}\n                  onChange={(e) => setVerificationFilter(e.target.value)}\n                >\n                  <MenuItem value=\"all\">Todas</MenuItem>\n                  <MenuItem value=\"verified\">Verificadas</MenuItem>\n                  <MenuItem value=\"unverified\">Sin Verificar</MenuItem>\n                </Select>\n              </FormControl>\n            </Grid>\n          </Grid>\n        </Paper>\n      )}\n\n      {/* Tabs por tipo */}\n      <Box sx={{ mb: 2 }}>\n        <Tabs value={activeTab} onChange={handleTabChange} variant=\"scrollable\" scrollButtons=\"auto\">\n          <Tab label={`Todas (${filteredPhotos.length})`} />\n          {Object.entries(photosByType).map(([type, photos]) => (\n            <Tab key={type} label={`${getPhotoTypeLabel(type)} (${photos.length})`} />\n          ))}\n        </Tabs>\n      </Box>\n\n      {/* Panel: Todas las fotos */}\n      <TabPanel value={activeTab} index={0}>\n        {filteredPhotos.length === 0 ? (\n          <Paper sx={{ p: 4, textAlign: 'center' }}>\n            <CameraIcon sx={{ fontSize: 64, color: 'text.disabled', mb: 2 }} />\n            <Typography variant=\"h6\" color=\"text.secondary\" gutterBottom>\n              No hay fotos disponibles\n            </Typography>\n            <Typography variant=\"body2\" color=\"text.secondary\">\n              {showUploadButton ? 'Haz clic en \"Nueva Foto\" para agregar la primera.' : ''}\n            </Typography>\n          </Paper>\n        ) : (\n          <Grid container spacing={2}>\n            {filteredPhotos.map((photo) => (\n              <Grid item xs={12} sm={6} md={4} lg={3} key={photo.id}>\n                <Card \n                  sx={{ \n                    cursor: 'pointer',\n                    transition: 'transform 0.2s',\n                    '&:hover': { transform: 'scale(1.02)' }\n                  }}\n                  onClick={() => handlePhotoClick(photo)}\n                >\n                  <Box sx={{ position: 'relative' }}>\n                    <CardMedia\n                      component=\"img\"\n                      height=\"200\"\n                      image={photo.file_url}\n                      alt={photo.title || 'Foto'}\n                      sx={{ objectFit: 'cover' }}\n                    />\n                    \n                    {/* Overlay con informaci칩n */}\n                    <Box\n                      sx={{\n                        position: 'absolute',\n                        top: 8,\n                        right: 8,\n                        display: 'flex',\n                        gap: 0.5,\n                      }}\n                    >\n                      <Chip \n                        label={getPhotoTypeLabel(photo.type)}\n                        color={getPhotoTypeColor(photo.type)}\n                        size=\"small\"\n                        sx={{ fontSize: '0.7rem' }}\n                      />\n                      {photo.is_verified ? (\n                        <Chip\n                          icon={<VerifiedIcon />}\n                          label=\"Verificada\"\n                          color=\"success\"\n                          size=\"small\"\n                          sx={{ fontSize: '0.7rem' }}\n                        />\n                      ) : (\n                        <Chip\n                          icon={<UnverifiedIcon />}\n                          label=\"Sin verificar\"\n                          color=\"warning\"\n                          size=\"small\"\n                          sx={{ fontSize: '0.7rem' }}\n                        />\n                      )}\n                    </Box>\n                    \n                    {/* Men칰 de acciones */}\n                    <IconButton\n                      sx={{\n                        position: 'absolute',\n                        bottom: 8,\n                        right: 8,\n                        bgcolor: 'rgba(0,0,0,0.5)',\n                        color: 'white',\n                        '&:hover': { bgcolor: 'rgba(0,0,0,0.7)' }\n                      }}\n                      size=\"small\"\n                      onClick={(e) => handleMenuClick(e, photo)}\n                    >\n                      <MoreVertIcon fontSize=\"small\" />\n                    </IconButton>\n                  </Box>\n                  \n                  <CardContent sx={{ pb: 1 }}>\n                    <Typography variant=\"subtitle2\" noWrap>\n                      {photo.title || 'Sin t칤tulo'}\n                    </Typography>\n                    \n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mt: 1 }}>\n                      <TimeIcon sx={{ fontSize: 16, color: 'text.disabled' }} />\n                      <Typography variant=\"caption\" color=\"text.secondary\">\n                        {format(new Date(photo.taken_at), 'dd/MM/yyyy HH:mm', { locale: es })}\n                      </Typography>\n                    </Box>\n                    \n                    {photo.notes && (\n                      <Typography variant=\"caption\" color=\"text.secondary\" sx={{ \n                        display: 'block',\n                        mt: 0.5,\n                        overflow: 'hidden',\n                        textOverflow: 'ellipsis',\n                        whiteSpace: 'nowrap'\n                      }}>\n                        {photo.notes}\n                      </Typography>\n                    )}\n                  </CardContent>\n                </Card>\n              </Grid>\n            ))}\n          </Grid>\n        )}\n      </TabPanel>\n\n      {/* Panels por tipo */}\n      {Object.entries(photosByType).map(([type, typePhotos], index) => (\n        <TabPanel key={type} value={activeTab} index={index + 1}>\n          <Grid container spacing={2}>\n            {typePhotos.map((photo) => (\n              <Grid item xs={12} sm={6} md={4} lg={3} key={photo.id}>\n                <Card \n                  sx={{ \n                    cursor: 'pointer',\n                    transition: 'transform 0.2s',\n                    '&:hover': { transform: 'scale(1.02)' }\n                  }}\n                  onClick={() => handlePhotoClick(photo)}\n                >\n                  <CardMedia\n                    component=\"img\"\n                    height=\"200\"\n                    image={photo.file_url}\n                    alt={photo.title || 'Foto'}\n                    sx={{ objectFit: 'cover' }}\n                  />\n                  \n                  <CardContent>\n                    <Typography variant=\"subtitle2\" noWrap>\n                      {photo.title || 'Sin t칤tulo'}\n                    </Typography>\n                    <Typography variant=\"caption\" color=\"text.secondary\">\n                      {format(new Date(photo.taken_at), 'dd/MM/yyyy HH:mm', { locale: es })}\n                    </Typography>\n                  </CardContent>\n                </Card>\n              </Grid>\n            ))}\n          </Grid>\n        </TabPanel>\n      ))}\n\n      {/* Men칰 contextual */}\n      <Menu\n        anchorEl={menuAnchor}\n        open={Boolean(menuAnchor)}\n        onClose={handleMenuClose}\n      >\n        <MenuItem onClick={() => setOpenViewer(true)}>\n          <ListItemIcon><ViewIcon /></ListItemIcon>\n          <ListItemText>Ver detalles</ListItemText>\n        </MenuItem>\n        <MenuItem onClick={handleDownloadPhoto}>\n          <ListItemIcon><DownloadIcon /></ListItemIcon>\n          <ListItemText>Descargar</ListItemText>\n        </MenuItem>\n        {user?.role === 'admin' && (\n          <MenuItem onClick={handleDeletePhoto}>\n            <ListItemIcon><DeleteIcon /></ListItemIcon>\n            <ListItemText>Eliminar</ListItemText>\n          </MenuItem>\n        )}\n      </Menu>\n\n      {/* Dialog de visualizaci칩n de foto */}\n      <Dialog\n        open={openViewer}\n        onClose={() => setOpenViewer(false)}\n        maxWidth=\"md\"\n        fullWidth\n      >\n        {selectedPhoto && (\n          <>\n            <DialogContent sx={{ p: 0 }}>\n              <Box sx={{ position: 'relative' }}>\n                <img\n                  src={selectedPhoto.file_url}\n                  alt={selectedPhoto.title || 'Foto'}\n                  style={{ width: '100%', height: 'auto', maxHeight: '70vh', objectFit: 'contain' }}\n                />\n                \n                {/* Informaci칩n superpuesta */}\n                <Paper \n                  sx={{ \n                    position: 'absolute',\n                    bottom: 16,\n                    left: 16,\n                    right: 16,\n                    p: 2,\n                    bgcolor: 'rgba(255,255,255,0.95)'\n                  }}\n                >\n                  <Typography variant=\"h6\" gutterBottom>\n                    {selectedPhoto.title || 'Sin t칤tulo'}\n                  </Typography>\n                  \n                  <Grid container spacing={2}>\n                    <Grid item xs={12} sm={6}>\n                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>\n                        <Chip \n                          label={getPhotoTypeLabel(selectedPhoto.type)}\n                          color={getPhotoTypeColor(selectedPhoto.type)}\n                          size=\"small\"\n                        />\n                        {selectedPhoto.is_verified ? (\n                          <Chip icon={<VerifiedIcon />} label=\"Verificada\" color=\"success\" size=\"small\" />\n                        ) : (\n                          <Chip icon={<UnverifiedIcon />} label=\"Sin verificar\" color=\"warning\" size=\"small\" />\n                        )}\n                      </Box>\n                      \n                      <Typography variant=\"body2\" sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>\n                        <TimeIcon fontSize=\"small\" />\n                        {format(new Date(selectedPhoto.taken_at), 'PPPP', { locale: es })}\n                      </Typography>\n                      \n                      <Typography variant=\"body2\" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\n                        <PersonIcon fontSize=\"small\" />\n                        Tomada por: Usuario\n                      </Typography>\n                    </Grid>\n                    \n                    <Grid item xs={12} sm={6}>\n                      {selectedPhoto.notes && (\n                        <Typography variant=\"body2\" sx={{ mb: 1 }}>\n                          <strong>Notas:</strong> {selectedPhoto.notes}\n                        </Typography>\n                      )}\n                      \n                      <Typography variant=\"body2\">\n                        <strong>Archivo:</strong> {selectedPhoto.file_name}\n                      </Typography>\n                    </Grid>\n                  </Grid>\n                </Paper>\n              </Box>\n            </DialogContent>\n            \n            <DialogActions>\n              <Button startIcon={<DownloadIcon />} onClick={handleDownloadPhoto}>\n                Descargar\n              </Button>\n              <Button onClick={() => setOpenViewer(false)}>Cerrar</Button>\n            </DialogActions>\n          </>\n        )}\n      </Dialog>\n\n      {/* Dialog de upload */}\n      <PhotoUpload\n        open={openUpload}\n        onClose={() => setOpenUpload(false)}\n        onPhotoUploaded={(photo) => {\n          setPhotos(prev => [photo, ...prev]);\n          setOpenUpload(false);\n        }}\n        tripId={tripId}\n        vehicleId={vehicleId}\n        maintenanceId={maintenanceId}\n      />\n\n      {/* FAB para agregar fotos desde m칩vil */}\n      {showUploadButton && (\n        <Fab\n          color=\"primary\"\n          sx={{ \n            position: 'fixed', \n            bottom: 16, \n            right: 16,\n            display: { xs: 'flex', sm: 'none' } // Solo en m칩vil\n          }}\n          onClick={() => setOpenUpload(true)}\n        >\n          <AddIcon />\n        </Fab>\n      )}\n    </Box>\n  );\n};\n\nexport default PhotoGallery;